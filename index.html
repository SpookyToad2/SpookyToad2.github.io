<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TF2 Datamap Explorer (GitHub Hosted)</title>
    <style>
        /* [Styles remain the same as previous version] */
        :root { --bg: #1e1e1e; --sidebar: #252526; --text: #cccccc; --accent: #007acc; --border: #333; --header: #333333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; }
        header { background-color: var(--header); padding: 10px 20px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }
        .container { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 320px; background-color: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        #search-box { padding: 10px; background: #2d2d2d; display: flex; flex-direction: column; gap: 8px; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; background: #3c3c3c; border: 1px solid var(--border); color: white; border-radius: 4px; }
        #class-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
        #class-list li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); }
        #class-list li:hover { background: #2a2d2e; }
        #class-list li.active { background: var(--accent); color: white; }
        #main-content { flex: 1; padding: 20px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
        .flag-pill { display: inline-block; padding: 2px 6px; margin-right: 4px; border-radius: 3px; font-size: 0.75em; background: #444; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div id="file-status">⏳ Fetching datamaps.txt from GitHub...</div>
    <div style="margin-left: auto; display: flex; gap: 15px; align-items: center;">
        <select id="flag-filter" style="width: auto;">
            <option value="">All Flags</option>
            <option value="Save">Save</option>
            <option value="Key">Key</option>
            <option value="Input">Input</option>
            <option value="Output">Output</option>
        </select>
    </div>
</header>

<div class="container">
    <div id="sidebar">
        <div id="search-box">
            <input type="text" id="class-search" placeholder="Search Class (e.g. CBaseEntity)">
            <input type="text" id="classname-search" placeholder="Search Classname (e.g. _plasma)">
        </div>
        <ul id="class-list"></ul>
    </div>
    <div id="main-content">
        <div id="viewer-ui" class="hidden">
            <h1 id="selected-class-name">Select a Class</h1>
            <p id="selected-class-internal" style="opacity: 0.6;"></p>
            <div id="tables-container"></div>
        </div>
    </div>
</div>

<script>
    let masterData = [];

    // --- AUTOMATIC FETCH FOR GITHUB PAGES ---
    async function loadData() {
        const statusEl = document.getElementById('file-status');
        try {
            // Append a timestamp to bypass GitHub Pages caching
            const response = await fetch('./datamaps.txt?t=' + new Date().getTime());
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const text = await response.text();
            masterData = parseDataMap(text);
            
            statusEl.innerText = `✅ Loaded ${masterData.length} classes`;
            document.getElementById('viewer-ui').classList.remove('hidden');
            renderClassList();
        } catch (err) {
            statusEl.innerHTML = `<span style="color:red">❌ Failed to load datamaps.txt: ${err.message}</span>`;
        }
    }

    // --- PARSER (Supports Classnames & Sub-Tables) ---
    function parseDataMap(text) {
        const lines = text.split(/\r?\n/);
        const classes = [];
        let currentClass = null;
        let currentSubTable = null;

        lines.forEach(line => {
            // Match Class Header 
            const classMatch = line.match(/^([A-Za-z0-9_]+)\s+-\s+([A-Za-z0-9_]+)/);
            // Match Sub-Class Table [cite: 1, 11]
            const subTableMatch = line.match(/^\s+Sub-Class Table \((\d+) Deep\):\s+([A-Za-z0-9_]+)\s+-\s+([A-Za-z0-9_]+)/);
            // Match Fields 
            const fieldMatch = line.match(/^\s*-\s+([A-Za-z0-9_]+)\s+\(Offset\s+(\d+)\)\s+\(([^)]+)\)\(([^)]+)\)(?:\s+-\s+(.+))?$/);

            if (classMatch && !line.includes('Sub-Class Table')) {
                currentClass = { name: classMatch[1], internal: classMatch[2], fields: [], subTables: [] };
                currentSubTable = null;
                classes.push(currentClass);
            } else if (subTableMatch && currentClass) {
                currentSubTable = { depth: subTableMatch[1], prop: subTableMatch[2], className: subTableMatch[3], fields: [] };
                currentClass.subTables.push(currentSubTable);
            } else if (fieldMatch && currentClass) {
                const field = { name: fieldMatch[1], offset: fieldMatch[2], flags: fieldMatch[3].split('|'), size: fieldMatch[4], key: fieldMatch[5] || "" };
                (currentSubTable ? currentSubTable.fields : currentClass.fields).push(field);
            }
        });
        return classes;
    }

    // --- UI LOGIC ---
    function renderClassList() {
        const qC = document.getElementById('class-search').value.toLowerCase();
        const qI = document.getElementById('classname-search').value.toLowerCase();
        const filtered = masterData.filter(c => c.name.toLowerCase().includes(qC) && c.internal.toLowerCase().includes(qI));
        
        document.getElementById('class-list').innerHTML = filtered.map(c => `
            <li onclick="selectClass('${c.name}', '${c.internal}')">
                <div style="font-weight:bold">${c.name}</div>
                <div style="font-size:0.8em; opacity:0.6">${c.internal}</div>
            </li>
        `).join('');
    }

    function selectClass(name, internal) {
        const cls = masterData.find(c => c.name === name && c.internal === internal);
        if (!cls) return;

        document.getElementById('selected-class-name').innerText = cls.name;
        document.getElementById('selected-class-internal').innerText = `Engine Classname: ${cls.internal}`;
        
        const container = document.getElementById('tables-container');
        container.innerHTML = '<h3>Base Fields</h3>' + renderTable(cls.fields);
        
        cls.subTables.forEach(sub => {
            container.innerHTML += `<div style="background:#333; padding:5px; margin:10px 0;">Sub-Class: ${sub.prop} (${sub.className})</div>`;
            container.innerHTML += renderTable(sub.fields);
        });
    }

    function renderTable(fields) {
        const filter = document.getElementById('flag-filter').value;
        const filtered = filter ? fields.filter(f => f.flags.includes(filter)) : fields;
        if (filtered.length === 0) return "<p>No matches for selected flag.</p>";

        return `<table><thead><tr><th>Property</th><th>Offset</th><th>Flags</th><th>Key</th></tr></thead><tbody>` + 
            filtered.map(f => `<tr><td>${f.name}</td><td>${f.offset}</td><td>${f.flags.map(fl => `<span class="flag-pill">${fl}</span>`).join('')}</td><td>${f.key}</td></tr>`).join('') + 
            `</tbody></table>`;
    }

    document.getElementById('class-search').addEventListener('input', renderClassList);
    document.getElementById('classname-search').addEventListener('input', renderClassList);
    document.getElementById('flag-filter').addEventListener('change', renderClassList);

    loadData();
</script>
</body>
</html>